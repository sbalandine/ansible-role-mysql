# === Optimized my.cnf configuration for MySQL/MariaSQL (on Ubuntu, CentOS etc. servers) ===
#
# The settings provided below are a starting point for a 8-16 GB RAM server with 4-8 CPU cores.
# If you have different resources available you should adjust accordingly to save CPU, RAM & disk I/O usage.
#

{{ ansible_managed | comment }}

[client]
port = {{ mysql_port }}
socket = {{ mysql_socket }}

[mysqld]
# === Required Settings ===
basedir                         = /usr
bind_address                    = {{ mysql_bind_address }} # Change to 0.0.0.0 to allow remote connections
datadir                         = {{ mysql_datadir }}
max_allowed_packet              = {{ mysql_max_allowed_packet }}
max_connect_errors              = 1000000
pid_file                        = {{ mysql_pid_file }}
port                            = {{ mysql_port }}
skip_external_locking
{% if mysql_skip_name_resolve %}
skip-name-resolve
{% endif %}
socket                          = {{ mysql_socket }}
tmpdir                          = /tmp
user                            = mysql

# === SQL Compatibility Mode ===
# Enable for b/c with databases created in older MySQL/MariaDB versions
# (e.g. when using null dates)
{% if mysql_sql_mode %}
sql_mode = {{ mysql_sql_mode }} # ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION,ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES
{% endif %}

# === InnoDB Settings ===
default_storage_engine          = InnoDB
innodb_buffer_pool_instances    = 4     # Use 1 instance per 1GB of InnoDB pool size
innodb_buffer_pool_size         = {{ mysql_innodb_buffer_pool_size }}
innodb_file_per_table           = {{ mysql_innodb_file_per_table }}
innodb_flush_log_at_trx_commit  = {{ mysql_innodb_flush_log_at_trx_commit }}
innodb_flush_method             = O_DIRECT
innodb_log_buffer_size          = {{ mysql_innodb_log_buffer_size }}
innodb_log_file_size            = {{ mysql_innodb_log_file_size }}
innodb_stats_on_metadata        = 0

#innodb_temp_data_file_path     = ibtmp1:64M:autoextend:max:20G # Control the maximum size for the ibtmp1 file
#innodb_thread_concurrency      = 4     # Optional: Set to the number of CPUs on your system (minus 1 or 2) to better
                                        # contain CPU usage. E.g. if your system has 8 CPUs, try 6 or 7 and check
                                        # the overall load produced by MySQL/MariaDB.

innodb_read_io_threads          = 64
innodb_write_io_threads         = 64
#innodb_io_capacity             = 1000  # Max is 2000

{% if mysql_supports_innodb_large_prefix and '8.0.' not in mysql_cli_version.stdout %}
innodb_large_prefix             = {{ mysql_innodb_large_prefix }}
innodb_file_format              = {{ mysql_innodb_file_format }}
{% endif %}

innodb_lock_wait_timeout        = {{ mysql_innodb_lock_wait_timeout }}

# === MyISAM Settings ===
# The following 3 options are ONLY supported by MariaDB & up to MySQL 5.7
# Do NOT un-comment on MySQL 8.x+
{% if '8.0.' not in mysql_cli_version.stdout %}
#query_cache_limit               = {{ mysql_query_cache_limit }}
#query_cache_size                = {{ mysql_query_cache_size }}
{% endif %}
#query_cache_type               = {{ mysql_query_cache_type }}

key_buffer_size                 = {{ mysql_key_buffer_size }}   # UPD

low_priority_updates            = 1
concurrent_insert               = 2

myisam_sort_buffer_size = {{ mysql_myisam_sort_buffer_size }}

# === Connection Settings ===
max_connections                 = {{ mysql_max_connections }}

back_log                        = 512
thread_cache_size               = {{ mysql_thread_cache_size }}
thread_stack                    = 192K

interactive_timeout             = 180
wait_timeout                    = {{ mysql_wait_timeout }}

# For MySQL 5.7+ only (disabled by default)
#max_execution_time             = 30000 # Set a timeout limit for SELECT statements (value in milliseconds).
                                        # This option may be useful to address aggressive crawling on large sites,
                                        # but it can also cause issues (e.g. with backups). So use with extreme caution and test!
                                        # More info at: https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_max_execution_time

# For MariaDB 10.1.1+ only (disabled by default)
#max_statement_time             = 30    # The equivalent of "max_execution_time" in MySQL 5.7+ (set above)
                                        # The variable is of type double, thus you can use subsecond timeout.
                                        # For example you can use value 0.01 for 10 milliseconds timeout.
                                        # More info at: https://mariadb.com/kb/en/aborting-statements/

# === Buffer Settings ===
innodb_sort_buffer_size         = 2M    # UPD
join_buffer_size                = {{ mysql_join_buffer_size }}
read_buffer_size                = {{ mysql_read_buffer_size }}
read_rnd_buffer_size            = {{ mysql_read_rnd_buffer_size }}
sort_buffer_size                =  {{ mysql_sort_buffer_size }}

# === Table Settings ===
# In systemd managed systems like Ubuntu 16.04+ or CentOS 7+, you need to perform an extra action for table_open_cache & open_files_limit
# to be overriden (also see comment next to open_files_limit).
# E.g. for MySQL 5.7, please check: https://dev.mysql.com/doc/refman/5.7/en/using-systemd.html
# and for MariaDB check: https://mariadb.com/kb/en/library/systemd/
table_definition_cache          = 40000 # UPD
table_open_cache                = {{ mysql_table_open_cache }}
open_files_limit                = 60000 # UPD - This can be 2x to 3x the table_open_cache value or match the system's
                                        # open files limit usually set in /etc/sysctl.conf or /etc/security/limits.conf
                                        # In systemd managed systems this limit must also be set in:
                                        # /etc/systemd/system/mysqld.service.d/override.conf (for MySQL 5.7+) and
                                        # /etc/systemd/system/mariadb.service.d/override.conf (for MariaDB)

max_heap_table_size             = {{ mysql_max_heap_table_size }}
tmp_table_size                  = {{ mysql_tmp_table_size }}

# === Search Settings ===
ft_min_word_len                 = 3     # Minimum length of words to be indexed for search results

# === Logging ===
{% if mysql_log_error == 'syslog' or mysql_log == 'syslog' %}
syslog
syslog-tag = {{ mysql_syslog_tag }}
{% else %}
{% if mysql_log %}
log = {{ mysql_log }}
{% endif %}
log_error = {{ mysql_log_error }}
{% endif %}
log_queries_not_using_indexes   = 1
{% if mysql_slow_query_log_enabled %}
long_query_time                 = {{ mysql_slow_query_time }}
slow_query_log                  = 0     # Disabled for production
slow_query_log_file             = {{ mysql_slow_query_log_file }}
{% endif %}

[mysqldump]
# Variable reference
# For MySQL 5.7+:  https://dev.mysql.com/doc/refman/5.7/en/mysqldump.html
# For MariaDB:     https://mariadb.com/kb/en/library/mysqldump/
quick
quote_names
max_allowed_packet              = {{ mysql_mysqldump_max_allowed_packet }}

{% if mysql_replication_master %}
# Replication
server-id = {{ mysql_server_id }}

{% if mysql_replication_role == 'master' %}
log_bin = mysql-bin
log-bin-index = mysql-bin.index
expire_logs_days = {{ mysql_expire_logs_days }}
max_binlog_size = {{ mysql_max_binlog_size }}
binlog_format = {{mysql_binlog_format}}

{% for db in mysql_databases %}
{% if db.replicate|default(1) %}
binlog_do_db = {{ db.name }}
{% else %}
binlog_ignore_db = {{ db.name }}
{% endif %}
{% endfor %}
{% endif %}

{% if mysql_replication_role == 'slave' %}
read_only
relay-log = relay-bin
relay-log-index = relay-bin.index
{% endif %}
{% endif %}

# Disabling symbolic-links is recommended to prevent assorted security risks
symbolic-links = 0

# http://dev.mysql.com/doc/refman/5.5/en/performance-schema.html
;performance_schema

# Memory settings.
group_concat_max_len = {{ mysql_group_concat_max_len }}

# Other settings.
lower_case_table_names = {{ mysql_lower_case_table_names }}
event_scheduler = {{ mysql_event_scheduler_state }}

[mysqld_safe]
pid-file = {{ mysql_pid_file }}

{% if mysql_config_include_files | length %}
# * IMPORTANT: Additional settings that can override those from this file!
#   The files must end with '.cnf', otherwise they'll be ignored.
#
!includedir {{ mysql_config_include_dir }}
{% endif %}
